#!/bin/sh

# è°ƒè¯•ç”¨ set -x
# set -x

echo "ğŸ› æ‰§è¡Œ pre-commit é’©å­"
echo "å½“å‰ç›®å½•: $(pwd)"
echo "Nodeç‰ˆæœ¬: $(node -v)"
echo "PNPMç‰ˆæœ¬: $(pnpm -v)"

echo "âš™ï¸ è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·..."
node "$(dirname "$0")/update-version.js"

if [ -f .version-changed ]; then
  echo "âš ï¸ ç‰ˆæœ¬å·å·²æ›´æ–°ï¼Œè¯·é‡æ–°æäº¤"
  rm .version-changed
  exit 1
fi

echo "ğŸ“‚ æŸ¥æ‰¾å¾…æ£€æŸ¥æ–‡ä»¶..."
files=$(git diff --cached --name-only | grep -E '\.(js|ts|tsx|jsx)$' | grep -vE '^(\.husky|node_modules)/' || true)

echo "æ‰¾åˆ°æ–‡ä»¶åˆ—è¡¨:"
printf "  - %s\n" $files

[ -z "$files" ] && { echo "âœ… æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶"; exit 0; }

echo "ğŸ” TypeScript æ£€æŸ¥ä¸­..."
tsc_output=$(pnpm tsc --noEmit --pretty false 2>&1)
tsc_status=$?

echo "ğŸ§ª TypeScript è¿”å›ç : $tsc_status"

# --- ç»Ÿè®¡å’Œè¾“å‡º TypeScript é”™è¯¯å’Œè­¦å‘Šæ•°é‡å’Œè¯¦æƒ… ---
tsc_errors=$(echo "$tsc_output" | grep -E "error TS[0-9]+:" || true)
tsc_warnings=$(echo "$tsc_output" | grep -i "warning" || true)

if [ -n "$tsc_errors" ]; then
  echo "âŒ TypeScript é”™è¯¯è¯¦æƒ…:"
  echo "$tsc_errors"
fi

if [ -n "$tsc_warnings" ]; then
  echo "âš ï¸ TypeScript è­¦å‘Šè¯¦æƒ…:"
  echo "$tsc_warnings"
fi
# ---

if [ $tsc_status -ne 0 ]; then
  echo "âŒ TypeScript æ£€æŸ¥æœªé€šè¿‡ï¼Œç»ˆæ­¢æäº¤"
  exit 1
fi

echo "âœ… TypeScript æ£€æŸ¥é€šè¿‡"

echo "ğŸ” ESLint æ£€æŸ¥ä¸­..."
eslint_output=$(pnpm eslint $files --format unix 2>&1)
eslint_status=$?

echo "ğŸ§ª ESLint è¿”å›ç : $eslint_status"

# --- ç»Ÿè®¡ ESLint é”™è¯¯å’Œè­¦å‘Š ---
eslint_errors=$(echo "$eslint_output" | grep -E ":[0-9]+:[0-9]+: Error" || true)
eslint_warnings=$(echo "$eslint_output" | grep -E ":[0-9]+:[0-9]+: Warning" || true)

if [ -n "$eslint_errors" ]; then
  echo "âŒ ESLint é”™è¯¯è¯¦æƒ…:"
  echo "$eslint_errors"
fi

if [ -n "$eslint_warnings" ]; then
  echo "âš ï¸ ESLint è­¦å‘Šè¯¦æƒ…:"
  echo "$eslint_warnings"
fi
# ---

if [ $eslint_status -ne 0 ]; then
  echo "âŒ ESLint æ£€æŸ¥æœªé€šè¿‡ï¼Œç»ˆæ­¢æäº¤"
  exit 1
fi

if [ -n "$eslint_errors" ]; then
  echo "âŒ ESLint æ£€æŸ¥æœªé€šè¿‡ï¼ˆæ£€æµ‹åˆ°é”™è¯¯ï¼‰"
  exit 1
fi

echo "âœ… ESLint æ— é”™è¯¯ï¼ˆè­¦å‘Šå·²å¿½ç•¥ï¼‰"

echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œé’©å­æ‰§è¡Œå®Œæ¯•"
exit 0
